var waterfall=function(t){function o(t){t&&(w=t,w.waterfallWidth&&g.css("width",w.waterfallWidth),w.waterfallBg&&g.css("background",w.waterfallBg)),l(),a(g)&&(console.log("bottom"),h&&h())}function n(t){t?(t.forEach(function(t,o){t.image_url||(t.image_url="images/1.jpg")}),d=t,e()):alert("load error data")}function e(){f();var o=[],n=g.find(".new");n.each(function(){var n=t.Deferred();t(this).find("img").on("load",function(){n.resolve()}),o.push(n)}),t.when.apply(null,o).done(function(){i(),g.find(".new").each(function(){t(this).attr("class","item")})}).done(function(){a(g)&&(console.log("内容仍然不够"),h&&h())}).fail(function(){console.log("失败")})}function i(){var o=g.width(),n=g.find(".item"),e=n.outerWidth(!0),i=Math.floor(o/e);console.log(i),n.each(function(n,l){var a=t(l).outerHeight(!0)+10,c=(o-i*e)/(i-1);if(n<i)t(l).css({left:n*(e+c)+"px",top:0,opacity:1}),u[n]=a;else{var f=r(u);t(l).css({left:f*(e+c)+"px",top:u[f]+"px",opacity:1}),u[f]+=a}}),g.css("height",Math.max.apply(Math,u)+"px")}function l(){t(window).on("scroll",function(){s&&clearTimeout(s),s=setTimeout(function(){a()&&(console.log("bottom"),h&&h())},100)}),t(window).on("resize",function(){console.log("resize"),a()&&(console.log("bottom"),h&&h()),u=[],i()})}function a(){var o=g.height()-30;return o<t(window).scrollTop()+t(window).height()}function r(t){var o=t[0],n=0;return t.forEach(function(t,e){t<o&&(o=t,n=e)}),n}function c(t){h=t}function f(){var o="";d.forEach(function(t,n){o+='<div class="item new" style="width:'+w.itemWidth+"px;background:"+w.itemBg+'"><a href="'+t.url+'"><img src="'+t.image_url+'" alt=""></a><p>'+t.title+"</p></div>"}),g.append(t(o))}var u=[],s=null,d=[],h=null,g=t(".waterfall"),w={};return{init:o,render:n,toBottom:c}}($);$.extend({waterfall:waterfall});