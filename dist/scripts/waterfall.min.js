var waterfall=function(n){function o(n){n&&(p=n,p.waterfallBg&&d.css("background",p.waterfallBg),p.colNum&&p.margin&&(w=Math.floor((h-(p.colNum-1)*p.margin)/p.colNum)),p.margin=n.margin),a(),l(d)&&(console.log("bottom"),m&&m())}function t(n){n?(n.forEach(function(n,o){n.image_url||(n.image_url="images/1.jpg")}),g=n,i()):alert("load error data")}function i(){f();var o=[],t=d.find(".new");t.each(function(){var t=n.Deferred();n(this).find("img").on("load",function(){t.resolve()}),o.push(t)}),n.when.apply(null,o).done(function(){e(),d.find(".new").each(function(){n(this).attr("class","item")})}).done(function(){l(d)&&(console.log("内容仍然不够"),m&&m())}).fail(function(){console.log("失败")})}function e(){var o=d.find(".item"),t=p.colNum,i=p.margin;console.log(t),o.each(function(o,e){var a=n(e).outerHeight(!0)+i;if(o<t)n(e).css({left:o*(w+i)+"px",top:0,opacity:1}),u[o]=a;else{var l=r(u);n(e).css({left:l*(w+i)+"px",top:u[l]+"px",opacity:1}),u[l]+=a}}),d.css("height",Math.max.apply(Math,u)+"px")}function a(){n(window).on("scroll",function(){s&&clearTimeout(s),s=setTimeout(function(){l()&&(console.log("bottom"),m&&m())},100)}),n(window).on("resize",function(){console.log("resize"),l()&&(console.log("bottom"),m&&m()),u=[],e()})}function l(){var o=d.height()-30;return o<n(window).scrollTop()+n(window).height()}function r(n){var o=n[0],t=0;return n.forEach(function(n,i){n<o&&(o=n,t=i)}),t}function c(n){m=n}function f(){var o="";g.forEach(function(n,t){o+='<div class="item new" style="width:'+w+"px;background:"+p.itemBg+'"><a href="'+n.url+'"><img src="'+n.image_url+'" alt=""></a><p>'+n.title+"</p></div>"}),d.append(n(o))}var u=[],s=null,g=[],m=null,d=n(".waterfall"),h=d.width(),p={},w=0;return{init:o,render:t,toBottom:c}}($);$.extend({waterfall:waterfall});