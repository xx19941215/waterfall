var waterfall=function(n){function t(n){p=n,p.waterfallBg&&g.css("background",p.waterfallBg),p.colNum&&p.margin&&(w=Math.floor((m-(p.colNum-1)*p.margin)/p.colNum)),a(),r(g)&&h&&h()}function o(n){n?(n.forEach(function(n,t){n.image_url||(n.image_url="images/1.jpg")}),d=n,i()):alert("load error data")}function i(){f();var t=[],o=g.find(".new");o.each(function(){var o=n.Deferred();n(this).find("img").on("load",function(){o.resolve()}),t.push(o)}),n.when.apply(null,t).done(function(){e(),g.find(".new").each(function(){n(this).attr("class","item")})}).done(function(){r(g)&&h&&h()}).fail(function(){console.log("error")})}function e(){var t=g.find(".item"),o=p.colNum,i=p.margin;t.each(function(t,e){var a=n(e).outerHeight(!0)+i;if(t<o)n(e).css({left:t*(w+i)+"px",top:0,opacity:1}),u[t]=a;else{var r=l(u);n(e).css({left:r*(w+i)+"px",top:u[r]+"px",opacity:1}),u[r]+=a}}),g.css("height",Math.max.apply(Math,u)+"px")}function a(){n(window).on("scroll",function(){s&&clearTimeout(s),s=setTimeout(function(){r()&&h&&h()},100)}),n(window).on("resize",function(){console.log("resize"),r()&&h&&h(),u=[],e()})}function r(){var t=g.height()-30;return t<n(window).scrollTop()+n(window).height()}function l(n){var t=n[0],o=0;return n.forEach(function(n,i){n<t&&(t=n,o=i)}),o}function c(n){h=n}function f(){var t="";d.forEach(function(n,o){t+='<div class="item new" style="width:'+w+"px;background:"+p.itemBg+'"><a href="'+n.url+'"><img src="'+n.image_url+'" alt=""></a><p>'+n.title+"</p></div>"}),g.append(n(t))}var u=[],s=null,d=[],h=null,g=n(".waterfall"),m=g.width(),p={},w=0;return{init:t,render:o,toBottom:c}}($);$.extend({waterfall:waterfall});